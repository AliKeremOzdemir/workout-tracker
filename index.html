<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Fitness Tracker — ULTRA (Hotfix 1)</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#4CAF50" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  <style>body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:16px}</style>
</head>
<body>
  <h1>Workout & Meal Tracker</h1>
  <label>Hafta: <select id="week"></select></label>
  <label>Gün: <select id="day"><option value="1">Gün 1</option><option value="2">Gün 2</option><option value="3">Gün 3</option><option value="4">Gün 4</option></select></label>
  <div id="workout"></div>
  <script>
    // --- minimal core to repro fix ---
    const DB_NAME='trackerDB';const DB_VERSION=7;const STORE_LOGS='logs';const STORE_PLAN='plan';
    function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,DB_VERSION);r.onupgradeneeded=e=>{const db=e.target.result;if(!db.objectStoreNames.contains(STORE_LOGS))db.createObjectStore(STORE_LOGS,{keyPath:'id'});if(!db.objectStoreNames.contains(STORE_PLAN))db.createObjectStore(STORE_PLAN,{keyPath:'id'});};r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});}
    async function dbPut(s,v){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction(s,'readwrite');tx.objectStore(s).put(v);tx.oncomplete=()=>res(true);tx.onerror=()=>rej(tx.error);});}
    async function dbGet(s,id){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction(s,'readonly');const q=tx.objectStore(s).get(id);q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error);});}

    function basePlan(week,day){return[{name:'Test Egzersizi',type:'reps',sets:3,reps:5}]}
    function inflate(plan){return plan.map(ex=>({name:ex.name,type:ex.type,targetSets:ex.sets,targetReps:ex.reps||null,targetSeconds:ex.seconds||null,sets:Array.from({length:ex.sets},(_,i)=>({index:i+1,done:false,actual:(ex.reps||ex.seconds||0)}))}))}

    const weekSel=document.getElementById('week');
    for(let w=1; w<=24; w++){ const opt=document.createElement('option'); opt.value=w; opt.textContent='Hafta '+w; weekSel.appendChild(opt);} 
    weekSel.value=1; const daySel=document.getElementById('day');

    async function getPlanFor(week,day){ const override=await dbGet(STORE_PLAN,`w${week}-d${day}`); if(override&&override.plan) return inflate(override.plan); return inflate(basePlan(week,day)); }

    let currentLog=null;
    async function render(){ const week=parseInt(weekSel.value), day=parseInt(daySel.value); const id=`w${week}-d${day}`; let log=await dbGet(STORE_LOGS,id); if(!log){ const plan=await getPlanFor(week,day); log={id,week,day,exercises:plan,updatedAt:new Date().toISOString()}; await dbPut(STORE_LOGS,log);} currentLog=log; const cont=document.getElementById('workout'); cont.innerHTML=''; cont.textContent=`Render OK → Hafta ${week}, Gün ${day}`; }

    // ✅ FIX: redeclare etmiyoruz; sadece listener ekliyoruz
    weekSel.addEventListener('change', render);
    daySel.addEventListener('change', render);

    render();
  </script>
</body>
</html>