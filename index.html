<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Fitness Tracker — ULTRA (Plan + Auto Prog + PR + Özet + Takvim + OneDrive Sync)</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#4CAF50" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">
  <!-- MSAL (OneDrive/Graph) -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  <style>
    :root{--green:#2e7d32;--blue:#1565c0;--gray:#455a64;--orange:#ef6c00;--bg:#fafafa}
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:16px;background:var(--bg);line-height:1.45}
    h1{margin:6px 0 10px;text-align:center}
    .toolbar{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:10px}
    select,button{padding:10px;border-radius:8px;border:1px solid #ccc;background:#fff}
    .exercise{border:1px solid #e0e0e0;border-radius:10px;padding:12px;margin-bottom:10px;background:#fff}
    .exercise h3{margin:0 0 6px}
    .target{color:var(--gray);font-size:13px}
    .sets{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .set{border:1px solid #ddd;border-radius:8px;padding:6px}
    .set input[type=number]{width:64px}
    .row{display:flex;gap:8px;align-items:center}
    .footer{position:sticky;bottom:0;background:#fff;padding:10px 0;margin-top:10px;border-top:1px solid #eee}
    .grid4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px}
    .footer button{width:100%;padding:12px;font-weight:600;color:#fff;border:none;border-radius:8px}
    #saveBtn{background:var(--green)}
    #completeBtn{background:var(--blue)}
    #recalcBtn{background:var(--orange)}
    #status{margin-top:8px;color:var(--gray);font-size:12px}
    @media(max-width:1000px){.toolbar{grid-template-columns:1fr 1fr 1fr}.grid4{grid-template-columns:1fr 1fr}}
    @media(max-width:640px){.toolbar{grid-template-columns:1fr 1fr}.grid4{grid-template-columns:1fr}}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px}
    .modal.show{display:flex}
    .card{background:#fff;max-width:980px;width:100%;border-radius:12px;padding:16px;border:1px solid #e0e0e0}
    .closebar{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .pill{border:1px solid #ccc;border-radius:999px;padding:6px 10px;display:inline-block;background:#f7f7f7}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #eee;padding:6px;text-align:left;font-size:13px}
    #prChart, #summaryChart, #heatCanvas{background:#fff;border:1px solid #eee;border-radius:8px}
    .banner{position:fixed;left:0;right:0;bottom:0;background:#263238;color:#fff;padding:10px 16px;display:none}
    .banner.show{display:block}
    .banner button{background:#4CAF50;color:#fff;border:none;padding:8px 12px;border-radius:6px;margin-left:8px}
    .syncbar{display:flex;gap:6px;align-items:center;justify-content:flex-end}
    .syncbar button{padding:8px 10px}
  </style>
</head>
<body>
  <h1>Workout & Meal Tracker</h1>
  <div class="toolbar">
    <div class="row"><label for="week">Hafta:&nbsp;</label><select id="week"></select></div>
    <div class="row"><label for="day">Gün:&nbsp;</label>
      <select id="day"><option value="1">Gün 1</option><option value="2">Gün 2</option><option value="3">Gün 3</option><option value="4">Gün 4</option></select>
    </div>
    <div class="row" style="gap:6px;justify-content:flex-start">
      <button id="summaryBtn">Haftalık Özet</button>
      <button id="calendarBtn">Takvim</button>
      <button id="prBtn">PR Grafiği</button>
      <button id="planBtn">Plan Editörü</button>
    </div>
    <div class="syncbar">
      <button id="settingsBtn">Ayarlar</button>
      <button id="exportBtn">Dışa Aktar</button>
      <label class="pill">İçe Aktar <input type="file" id="importFile" accept="application/json" style="display:none"></label>
      <button id="signinBtn">Microsoft ile Giriş</button>
      <button id="signoutBtn" style="display:none">Çıkış</button>
      <button id="syncBtn" title="OneDrive senkron">Senkronize Et</button>
    </div>
  </div>

  <div id="workout"></div>

  <div class="footer">
    <div class="grid4">
      <button id="saveBtn">Kaydet</button>
      <button id="completeBtn">Antrenmanı Tamamla</button>
      <button id="recalcBtn">Bir Sonraki Haftayı Hesapla</button>
      <button id="clearBtn" style="background:#9e9e9e">Temizle</button>
    </div>
    <div id="status"></div>
  </div>

  <div id="updateBanner" class="banner" aria-live="polite">Yeni sürüm hazır. <button id="reloadBtn">Yenile</button></div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal" aria-hidden="true">
    <div class="card">
      <div class="closebar"><h2>Progresyon Ayarları</h2><button id="closeSettings">Kapat</button></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <h3>Genel</h3>
          <label>Başarı eşiği (%): <input id="repSuccess" type="number" min="50" max="100" step="1"></label>
          <label>Başarısız eşiği (%): <input id="repFail" type="number" min="0" max="90" step="1"></label>
          <label>Artış/Azalış (tekrar): <input id="repInc" type="number" min="1" max="5"> <input id="repDec" type="number" min="1" max="5"></label>
          <label>Min/Max Tekrar: <input id="repMin" type="number" min="1" style="width:48%"> <input id="repMax" type="number" min="1" style="width:48%"></label>
          <label>Min/Max Set: <input id="setMin" type="number" min="1" style="width:48%"> <input id="setMax" type="number" min="1" style="width:48%"></label>
          <h3>Süre Bazlı</h3>
          <label>Başarı artışı (%): <input id="timeUpPct" type="number" min="5" max="50"></label>
          <label>Başarısız azalış (%): <input id="timeDownPct" type="number" min="5" max="50"></label>
          <label>Minimum saniye: <input id="timeMin" type="number" min="5"></label>
        </div>
        <div>
          <h3>Egzersiz Bazlı Geçersiz Kılmalar (JSON)</h3>
          <p class="pill">Örnek: {"Negatif Barfiks": {"repInc":2, "repMax":25}}</p>
          <textarea id="exOverrides" rows="14" style="width:100%" placeholder='{"Negatif Barfiks":{"repInc":2}}'></textarea>
        </div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
        <button id="resetDefaults">Varsayılanlara Dön</button>
        <button id="saveSettings" style="background:#2e7d32;color:#fff;border:none;border-radius:8px;padding:10px 14px">Kaydet</button>
      </div>
    </div>
  </div>

  <!-- Weekly Summary Modal -->
  <div id="summaryModal" class="modal" aria-hidden="true">
    <div class="card">
      <div class="closebar"><h2>Haftalık Özet</h2><button id="closeSummary">Kapat</button></div>
      <div id="summaryMeta" class="pill"></div>
      <canvas id="summaryChart" width="820" height="240"></canvas>
      <div id="reasonStats" style="margin-top:8px" class="pill"></div>
    </div>
  </div>

  <!-- Calendar / Heatmap Modal -->
  <div id="calendarModal" class="modal" aria-hidden="true">
    <div class="card">
      <div class="closebar"><h2>Takvim / Uyum Isı Haritası</h2><button id="closeCalendar">Kapat</button></div>
      <canvas id="heatCanvas" width="820" height="360" title="Tıklanabilir 24×4 ızgara"></canvas>
      <div class="pill">Renk: Kırmızı (düşük tamamlama) → Yeşil (yüksek tamamlama)</div>
    </div>
  </div>

  <!-- PR Chart Modal -->
  <div id="prModal" class="modal" aria-hidden="true">
    <div class="card">
      <div class="closebar"><h2>PR Grafiği</h2><button id="closePR">Kapat</button></div>
      <div class="row" style="gap:8px;align-items:center">
        <label for="prExercise">Egzersiz:</label>
        <select id="prExercise"></select>
        <label for="prType">Tür:</label>
        <select id="prType"><option value="reps">Tekrar</option><option value="time">Süre</option></select>
      </div>
      <canvas id="prChart" width="820" height="300"></canvas>
      <div id="prStats" style="margin-top:8px" class="pill"></div>
    </div>
  </div>

  <!-- Plan Editor Modal -->
  <div id="planModal" class="modal" aria-hidden="true">
    <div class="card" id="planEditor">
      <div class="closebar"><h2>Plan Editörü (Seçili Hafta/Gün)</h2><button id="closePlan">Kapat</button></div>
      <div class="row" style="gap:8px;align-items:center;margin-bottom:8px">
        <button id="addRow">Egzersiz Ekle</button>
        <button id="savePlan" style="background:#2e7d32;color:#fff;border:none;border-radius:8px;padding:8px 12px">Kaydet</button>
        <span class="pill">Not: Bu düzenleme yalnızca seçili gün için override plan oluşturur.</span>
      </div>
      <table>
        <thead><tr><th>#</th><th>Egzersiz</th><th>Tür</th><th>Set</th><th>Tekrar/sn</th><th>Yukarı</th><th>Aşağı</th><th>Sil</th></tr></thead>
        <tbody id="planTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Reason Modal -->
  <div id="reasonModal" class="modal" aria-hidden="true">
    <div class="card">
      <div class="closebar"><h2>Bugün neden düşük çıktı?</h2><button id="closeReason">Kapat</button></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <label><input type="checkbox" class="reasonBox" value="Zaman"/> Zaman</label>
        <label><input type="checkbox" class="reasonBox" value="Yorgunluk"/> Yorgunluk</label>
        <label><input type="checkbox" class="reasonBox" value="Ağrı/Sakatlık"/> Ağrı/Sakatlık</label>
        <label><input type="checkbox" class="reasonBox" value="Ekipman/Yer"/> Ekipman/Yer</label>
        <label><input type="checkbox" class="reasonBox" value="Seyahat"/> Seyahat</label>
        <label><input type="checkbox" class="reasonBox" value="Diğer"/> Diğer</label>
      </div>
      <textarea id="reasonText" rows="3" placeholder="Açıklama (opsiyonel)" style="width:100%;margin-top:8px"></textarea>
      <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
        <button id="reasonSave" style="background:#1565c0;color:#fff;border:none;border-radius:8px;padding:8px 12px">Kaydet</button>
      </div>
    </div>
  </div>

<script>
/***************** Settings *****************/
const DEFAULTS = { repSuccess:90, repFail:60, repInc:1, repDec:1, repMin:3, repMax:20, setMin:3, setMax:6, timeUpPct:10, timeDownPct:10, timeMin:10, exOverrides:{}, lowDayPrompt:70 };
function getCfg(){ try{ const raw=localStorage.getItem('cfg'); if(!raw) return {...DEFAULTS}; const o=JSON.parse(raw); if(!o.exOverrides) o.exOverrides={}; return {...DEFAULTS, ...o, exOverrides:{...DEFAULTS.exOverrides, ...o.exOverrides}}; } catch{ return {...DEFAULTS}; } }
function setCfg(o){ localStorage.setItem('cfg', JSON.stringify(o)); }

/*********************** IndexedDB ***********************/
const DB_NAME='trackerDB'; const DB_VERSION=7; const STORE_LOGS='logs'; const STORE_PLAN='plan';
function openDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB_NAME, DB_VERSION); r.onupgradeneeded=e=>{ const db=e.target.result; if(!db.objectStoreNames.contains(STORE_LOGS)) db.createObjectStore(STORE_LOGS,{keyPath:'id'}); if(!db.objectStoreNames.contains(STORE_PLAN)) db.createObjectStore(STORE_PLAN,{keyPath:'id'}); }; r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); }
async function dbPut(store,val){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(store,'readwrite'); tx.objectStore(store).put(val); tx.oncomplete=()=>res(true); tx.onerror=()=>rej(tx.error); }); }
async function dbGet(store,id){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(store,'readonly'); const q=tx.objectStore(store).get(id); q.onsuccess=()=>res(q.result); q.onerror=()=>rej(q.error); }); }
async function dbAll(store){ const db=await openDB(); return new Promise((res)=>{ const tx=db.transaction(store,'readonly'); const q=tx.objectStore(store).getAll(); q.onsuccess=()=>res(q.result||[]); }); }

/*********************** Base Plan & Helpers ***********************/
function getPhase(week){ if(week<=8) return 1; if(week<=16) return 2; return 3; }
function basePlan(week, day){ const p=getPhase(week); if(p===1){ if(day===1) return [ {name:'Negatif Barfiks',type:'reps',sets:5,reps:5}, {name:'Australian Pull-Up',type:'reps',sets:4,reps:10}, {name:'Dead Hang',type:'time',sets:3,seconds:30}, {name:'Hollow Hold',type:'time',sets:3,seconds:20} ]; if(day===2) return [ {name:'Eğik Şınav',type:'reps',sets:4,reps:12}, {name:'Pike Şınav',type:'reps',sets:4,reps:8}, {name:'Duvar Amut Bekleme',type:'time',sets:4,seconds:20}, {name:'Plank',type:'time',sets:3,seconds:30} ]; if(day===3) return [ {name:'Destekli Pistol Squat',type:'reps',sets:4,reps:8}, {name:'Bulgar Split Squat',type:'reps',sets:3,reps:10}, {name:'Glute Bridge',type:'reps',sets:3,reps:12}, {name:'Calf Raise',type:'reps',sets:3,reps:15} ]; if(day===4) return [ {name:'Asılı Diz Kaldırma',type:'reps',sets:4,reps:8}, {name:'Yan Plank',type:'time',sets:3,seconds:20}, {name:'Squat Bekleme',type:'time',sets:3,seconds:30} ]; } if(p===2){ if(day===1) return [ {name:'Patlayıcı Barfiks',type:'reps',sets:4,reps:6}, {name:'L-Sit Barfiks',type:'reps',sets:4,reps:6}, {name:'Bant Destekli Muscle-Up',type:'reps',sets:3,reps:5} ]; if(day===2) return [ {name:'Pike Şınav',type:'reps',sets:5,reps:8}, {name:'Dips',type:'reps',sets:4,reps:10}, {name:'Duvar Amut Şınavı',type:'reps',sets:4,reps:5} ]; if(day===3) return [ {name:'Pistol Squat İlerleme',type:'reps',sets:4,reps:6}, {name:'Bulgar Split Squat',type:'reps',sets:3,reps:10}, {name:'Nordic Curl',type:'reps',sets:3,reps:6}, {name:'Dragon Flag',type:'reps',sets:3,reps:6} ]; if(day===4) return [ {name:'Asılı Bacak Kaldırma',type:'reps',sets:4,reps:10}, {name:'Zıplama Squat',type:'reps',sets:4,reps:12}, {name:'Burpee',type:'reps',sets:4,reps:10} ]; } if(day===1) return [ {name:'Muscle-Up',type:'reps',sets:5,reps:5}, {name:'L-Sit Barfiks',type:'reps',sets:4,reps:8} ]; if(day===2) return [ {name:'Amut Şınav Progression',type:'reps',sets:5,reps:6}, {name:'Archer Şınav',type:'reps',sets:3,reps:8} ]; if(day===3) return [ {name:'Pistol Squat',type:'reps',sets:4,reps:10}, {name:'Nordic Curl',type:'reps',sets:3,reps:8} ]; if(day===4) return [ {name:'Muscle-Up + Dips (superset)',type:'reps',sets:4,reps:5}, {name:'Amut Şınav Negatif',type:'reps',sets:4,reps:5} ]; }
function inflate(plan){ return plan.map(ex=>({ name:ex.name,type:ex.type,per:ex.per||null, targetSets:ex.sets, targetReps:ex.reps||null, targetSeconds:ex.seconds||null, sets:Array.from({length:ex.sets},(_,i)=>({index:i+1,done:false,actual:(ex.reps||ex.seconds||0),rpe:7})) })); }
async function getPlanFor(week,day){ const override=await dbGet(STORE_PLAN,`w${week}-d${day}`); if(override&&override.plan) return inflate(override.plan); return inflate(basePlan(week,day)); }

/*********************** Render ***********************/
const weekSel=document.getElementById('week'); for(let w=1; w<=24; w++){ const opt=document.createElement('option'); opt.value=w; opt.textContent='Hafta '+w; weekSel.appendChild(opt);} weekSel.value=1; const daySel=document.getElementById('day');
let currentLog=null;
async function render(){ const week=parseInt(weekSel.value), day=parseInt(daySel.value); const id=`w${week}-d${day}`; let log=await dbGet(STORE_LOGS,id); if(!log){ const plan=await getPlanFor(week,day); log={id,week,day,exercises:plan,updatedAt:new Date().toISOString()}; await dbPut(STORE_LOGS,log);} currentLog=log; const cont=document.getElementById('workout'); cont.innerHTML=''; log.exercises.forEach(ex=>{ const div=document.createElement('div'); div.className='exercise'; div.innerHTML=`<h3>${ex.name}</h3><div class="target">Hedef: ${ex.targetSets} × ${(ex.type==='reps'?ex.targetReps+' tekrar':ex.targetSeconds+' sn')}</div>`; const setsDiv=document.createElement('div'); setsDiv.className='sets'; ex.sets.forEach(s=>{ const sDiv=document.createElement('div'); sDiv.className='set'; const row=document.createElement('div'); row.className='row'; const label=document.createElement('span'); label.textContent='Set '+s.index; row.appendChild(label); const chk=document.createElement('input'); chk.type='checkbox'; chk.checked=s.done; chk.addEventListener('change',()=>{ s.done=chk.checked; saveDraft();}); row.appendChild(chk); const inp=document.createElement('input'); inp.type='number'; inp.min=0; inp.value=s.actual; inp.addEventListener('change',()=>{ s.actual=parseInt(inp.value||'0'); saveDraft();}); row.appendChild(inp); const unit=document.createElement('span'); unit.textContent=ex.type==='reps'?'tekrar':'sn'; row.appendChild(unit); const rpe=document.createElement('input'); rpe.type='number'; rpe.min=1; rpe.max=10; rpe.value=s.rpe||7; rpe.title='RPE (1-10)'; rpe.addEventListener('change',()=>{ s.rpe=parseInt(rpe.value||'7'); saveDraft();}); row.appendChild(rpe); sDiv.appendChild(row); setsDiv.appendChild(sDiv); }); div.appendChild(setsDiv); cont.appendChild(div); }); document.getElementById('status').textContent=`Hafta ${week}, Gün ${day} yüklendi.`; }
async function saveDraft(){ if(!currentLog) return; currentLog.updatedAt=new Date().toISOString(); await dbPut(STORE_LOGS,currentLog); document.getElementById('status').textContent='Taslak kaydedildi.'; }
function stats(log){ let setsTotal=0, setsDone=0, reps=0, secs=0; log.exercises.forEach(ex=>{ ex.sets.forEach(s=>{ setsTotal++; if(s.done) setsDone++; if(ex.type==='reps') reps+=s.actual; else secs+=s.actual; }); }); return {setsTotal, setsDone, completion: setsTotal?Math.round(setsDone/setsTotal*100):0, reps, secs}; }

/*********************** Auto Progression ***********************/
function mergedCfgForExercise(exName){ const cfg=getCfg(); const o=(cfg.exOverrides||{})[exName]||{}; return { ...cfg, ...o, exOverrides: cfg.exOverrides };
}
function nextTargetFrom(ex){ const cfg=mergedCfgForExercise(ex.name); const finished=ex.sets.filter(s=>s.done); const doneRatio=ex.sets.length?finished.length/ex.sets.length:0; if(ex.type==='reps'){ const avg=finished.length?Math.round(finished.reduce((a,b)=>a+b.actual,0)/finished.length):0; let sets=ex.targetSets, reps=ex.targetReps||0; if(doneRatio>=(cfg.repSuccess/100) && avg>=reps){ if(reps<cfg.repMax) reps += cfg.repInc; else if(sets<cfg.setMax) sets += 1; } else if(doneRatio<(cfg.repFail/100)){ if(reps>cfg.repMin) reps -= cfg.repDec; else if(sets>cfg.setMin) sets -= 1; } return {sets:Math.max(cfg.setMin,Math.min(cfg.setMax,sets)), reps:Math.max(cfg.repMin,Math.min(cfg.repMax,reps))}; } else { const avg=finished.length?Math.round(finished.reduce((a,b)=>a+b.actual,0)/finished.length):0; let sets=ex.targetSets, seconds=ex.targetSeconds||0; if(doneRatio>=(cfg.repSuccess/100) && avg>=seconds){ seconds=Math.round(seconds*(1+cfg.timeUpPct/100)); } else if(doneRatio<(cfg.repFail/100)){ seconds=Math.max(cfg.timeMin, Math.round(seconds*(1-cfg.timeDownPct/100))); } return {sets:Math.max(cfg.setMin,Math.min(cfg.setMax,sets)), seconds}; } }
async function writeNextWeek(curr){ const nextWeek=curr.week<24?curr.week+1:curr.week; const nextDay=curr.day; if(nextWeek===curr.week) return null; const computed=curr.exercises.map(ex=>{ const nxt=nextTargetFrom(ex); const o={name:ex.name,type:ex.type,sets:nxt.sets}; if(ex.type==='reps') o.reps=nxt.reps; else o.seconds=nxt.seconds; if(ex.per) o.per=ex.per; return o; }); const id=`w${nextWeek}-d${nextDay}`; await dbPut(STORE_PLAN,{id,plan:computed,basedOn:`w${curr.week}-d${curr.day}`,computedAt:new Date().toISOString()}); return id; }

// Low day reason capture
function openReasonModal(onSave){ document.getElementById('reasonModal').classList.add('show'); document.getElementById('reasonSave').onclick=()=>{ const boxes=[...document.querySelectorAll('.reasonBox')]; const sel=boxes.filter(b=>b.checked).map(b=>b.value); const txt=document.getElementById('reasonText').value.trim(); document.getElementById('reasonModal').classList.remove('show'); onSave({reasons:sel, note:txt}); boxes.forEach(b=> b.checked=false); document.getElementById('reasonText').value=''; } }

async function completeDay(){ if(!currentLog) return; const s=stats(currentLog); const done = async (extra)=>{ currentLog.completed=true; currentLog.completedAt=new Date().toISOString(); currentLog.stats=s; if(extra) currentLog.lowDay=extra; await dbPut(STORE_LOGS,currentLog); const nextId=await writeNextWeek(currentLog); document.getElementById('status').textContent=`Tamamlandı • %${s.completion} | Tekrar: ${s.reps} | Süre: ${s.secs}s${nextId?` • Sonraki plan (${nextId})`:''}`; const w=parseInt(weekSel.value), d=parseInt(daySel.value); if(d<4){ daySel.value=d+1; } else if(w<24){ weekSel.value=w+1; daySel.value=1; } render(); };
  const cfg=getCfg(); if(s.completion < (cfg.lowDayPrompt||70)){ openReasonModal(done); } else { done(); } }

async function recalcNext(){ if(!currentLog) return; const id=await writeNextWeek(currentLog); document.getElementById('status').textContent=`Sonraki hafta hesaplandı: ${id||'son hafta'}`; }
function clearData(){ if(confirm('Tüm yerel veriler silinsin mi?')){ localStorage.removeItem('cfg'); openDB().then(db=>{ const tx1=db.transaction(STORE_LOGS,'readwrite'); tx1.objectStore(STORE_LOGS).clear(); const tx2=db.transaction(STORE_PLAN,'readwrite'); tx2.objectStore(STORE_PLAN).clear(); tx1.oncomplete=()=>{ document.getElementById('status').textContent='Tüm veriler temizlendi.'; render(); }; }); } }

/*********************** Weekly Summary + Reasons ***********************/
async function weeklySummary(week){ const logs=await dbAll(STORE_LOGS); const weekLogs=logs.filter(l=>l.week===week); let st=0, sd=0, reps=0, secs=0; const perDay=[0,0,0,0]; const reasons={}; weekLogs.forEach(l=>{ const s=stats(l); st+=s.setsTotal; sd+=s.setsDone; reps+=s.reps; secs+=s.secs; perDay[l.day-1]=s.completion; if(l.lowDay && l.lowDay.reasons){ l.lowDay.reasons.forEach(r=> reasons[r]=(reasons[r]||0)+1 ); } }); const reasonStr = Object.keys(reasons).length? 'Nedenler: '+Object.entries(reasons).map(([k,v])=>`${k}:${v}`).join(' | '):''; return {completion: st?Math.round(sd/st*100):0, reps, secs, perDay, reasonStr}; }
function drawBars(canvas, arr){ const ctx=canvas.getContext('2d'); const W=canvas.width, H=canvas.height, pad=40; ctx.clearRect(0,0,W,H); ctx.strokeStyle='#ccc'; ctx.beginPath(); ctx.moveTo(pad,pad); ctx.lineTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.stroke(); const labels=['G1','G2','G3','G4']; const max=100; const barW=(W-pad*2)/(labels.length*1.8); for(let i=0;i<labels.length;i++){ const x= pad + (i*1.8+0.3)*barW; const val=arr[i]||0; const h=(val/max)*(H-pad*2); ctx.fillStyle='#90caf9'; ctx.fillRect(x, H-pad-h, barW, h); ctx.fillStyle='#333'; ctx.font='12px sans-serif'; ctx.fillText(labels[i], x+barW/4, H-10); ctx.fillText(val+'%', x+barW/4-4, H-pad-h-6); } }

/*********************** PR Graph (with SMA trend) ***********************/
async function allExercises(){ const logs=await dbAll(STORE_LOGS); const names=new Set(); logs.forEach(l=> (l.exercises||[]).forEach(ex=> names.add(ex.name))); return Array.from(names).sort(); }
function drawLine(canvas, pts, type){ const ctx=canvas.getContext('2d'); const W=canvas.width, H=canvas.height, pad=40; ctx.clearRect(0,0,W,H); const xs=pts.map(p=>p.x), ys=pts.map(p=>p.y); const minX=Math.min(...xs), maxX=Math.max(...xs); const minY=0, maxY=Math.max(1, Math.max(...ys)); const sx=x=> pad + (x-minX)/(maxX-minX||1)*(W-pad*2); const sy=y=> H-pad - (y-minY)/(maxY-minY||1)*(H-pad*2); // axes
  ctx.strokeStyle='#ccc'; ctx.beginPath(); ctx.moveTo(pad,pad); ctx.lineTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.stroke(); // main line
  ctx.strokeStyle='#1565c0'; ctx.lineWidth=2; ctx.beginPath(); pts.forEach((p,i)=>{ const X=sx(p.x), Y=sy(p.y); if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y); }); ctx.stroke(); // points
  ctx.fillStyle='#ef6c00'; pts.forEach(p=>{ ctx.beginPath(); ctx.arc(sx(p.x), sy(p.y), 3, 0, Math.PI*2); ctx.fill(); }); // SMA
  const win=5; if(pts.length>=win){ const sma=[]; for(let i=0;i<pts.length;i++){ const j=Math.max(0,i-win+1); const slice=pts.slice(j,i+1); const avg=slice.reduce((a,b)=>a+b.y,0)/slice.length; sma.push({x:pts[i].x, y:avg}); } ctx.strokeStyle='#2e7d32'; ctx.lineWidth=2; ctx.beginPath(); sma.forEach((p,i)=>{ const X=sx(p.x), Y=sy(p.y); if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y); }); ctx.stroke(); }
  ctx.fillStyle='#333'; ctx.font='12px sans-serif'; ctx.fillText(type==='reps'?'Tekrar':'Saniye', 10, 14); }
async function openPR(){ const sel=document.getElementById('prExercise'); sel.innerHTML=''; (await allExercises()).forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); }); await renderPR(); document.getElementById('prModal').classList.add('show'); }
async function renderPR(){ const ex=document.getElementById('prExercise').value; const typ=document.getElementById('prType').value; const logs=await dbAll(STORE_LOGS); const pts=[]; logs.filter(l=>l.completed).sort((a,b)=> new Date(a.completedAt||a.updatedAt)-new Date(b.completedAt||b.updatedAt)).forEach(l=>{ (l.exercises||[]).forEach(e=>{ if(e.name!==ex || e.type!==(typ==='reps'?'reps':'time')) return; const best=Math.max(...e.sets.filter(s=>s.done).map(s=>s.actual||0), 0); if(best>0){ pts.push({x:new Date(l.completedAt||l.updatedAt).getTime(), y:best}); } }); }); const canvas=document.getElementById('prChart'); if(pts.length===0){ const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle='#666'; ctx.fillText('Henüz veri yok', 20, 20); document.getElementById('prStats').textContent=''; return; } drawLine(canvas, pts, typ); const last=pts[pts.length-1].y, first=pts[0].y; const delta=last-first; const pct=first? Math.round(delta/first*100): 0; document.getElementById('prStats').textContent=`Son Değer: ${last} • Değişim: ${delta>=0?'+':''}${delta} (${pct}%)`; }

/*********************** Calendar Heatmap ***********************/
async function openCalendar(){ const canvas=document.getElementById('heatCanvas'); const ctx=canvas.getContext('2d'); const W=canvas.width, H=canvas.height; ctx.clearRect(0,0,W,H); const cellW=W/24, cellH=H/4; const logs=await dbAll(STORE_LOGS); // draw grid
  for(let w=1; w<=24; w++){ for(let d=1; d<=4; d++){ const id=`w${w}-d${d}`; const log=logs.find(l=>l.id===id); const comp= log && log.stats ? log.stats.completion : 0; const col = heatColor(comp); ctx.fillStyle=col; ctx.fillRect((w-1)*cellW, (d-1)*cellH, cellW-2, cellH-2); ctx.strokeStyle='#fff'; ctx.strokeRect((w-1)*cellW, (d-1)*cellH, cellW-2, cellH-2); } } // axes labels
  ctx.fillStyle='#333'; ctx.font='12px sans-serif'; for(let w=1; w<=24; w+=2){ ctx.fillText('H'+w, (w-1)*cellW+4, 12); } ['G1','G2','G3','G4'].forEach((g,i)=> ctx.fillText(g, 2, i*cellH+14));
  canvas.onclick=(e)=>{ const rect=canvas.getBoundingClientRect(); const x=e.clientX-rect.left, y=e.clientY-rect.top; const w=Math.floor(x/cellW)+1; const d=Math.floor(y/cellH)+1; weekSel.value=w; daySel.value=d; document.getElementById('calendarModal').classList.remove('show'); render(); };
  document.getElementById('calendarModal').classList.add('show'); }
function heatColor(pct){ const r=Math.round(255*(1-pct/100)); const g=Math.round(255*(pct/100)); return `rgb(${r},${g},100)`; }

/*********************** Plan Editor ***********************/
function eRow(i, ex){ return `<tr data-i="${i}"><td>${i+1}</td><td><input value="${ex.name||''}"/></td><td><select>${['reps','time'].map(t=>`<option ${ex.type===t?'selected':''} value="${t}">${t}</option>`).join('')}</select></td><td><input type="number" min="1" value="${ex.sets||3}"/></td><td><input type="number" min="1" value="${ex.reps||ex.seconds||5}"/></td><td><button class="up">↑</button></td><td><button class="down">↓</button></td><td><button class="del">Sil</button></td></tr>`; }
async function openPlanEditor(){ const week=parseInt(weekSel.value), day=parseInt(daySel.value); const id=`w${week}-d${day}`; const o=await dbGet(STORE_PLAN,id); let plan = o&&o.plan ? JSON.parse(JSON.stringify(o.plan)) : basePlan(week,day); const tb=document.getElementById('planTbody'); function refresh(){ tb.innerHTML= plan.map((ex,i)=> eRow(i, ex)).join(''); bindRowEvents(); } function bindRowEvents(){ Array.from(tb.querySelectorAll('tr')).forEach(tr=>{ const idx=parseInt(tr.dataset.i); const inputs=tr.querySelectorAll('input,select'); inputs[0].addEventListener('input',e=>{plan[idx].name=e.target.value;}); inputs[1].addEventListener('change',e=>{plan[idx].type=e.target.value;}); inputs[2].addEventListener('input',e=>{plan[idx].sets=parseInt(e.target.value||'1');}); inputs[3].addEventListener('input',e=>{ if(plan[idx].type==='reps') plan[idx].reps=parseInt(e.target.value||'1'); else plan[idx].seconds=parseInt(e.target.value||'1'); }); tr.querySelector('.del').onclick=()=>{ plan.splice(idx,1); refresh(); }; tr.querySelector('.up').onclick=()=>{ if(idx>0){ const t=plan[idx-1]; plan[idx-1]=plan[idx]; plan[idx]=t; refresh(); } }; tr.querySelector('.down').onclick=()=>{ if(idx<plan.length-1){ const t=plan[idx+1]; plan[idx+1]=plan[idx]; plan[idx]=t; refresh(); } }; }); }
  document.getElementById('addRow').onclick=()=>{ plan.push({name:'Yeni Egzersiz',type:'reps',sets:3,reps:5}); refresh(); };
  document.getElementById('savePlan').onclick=async ()=>{ await dbPut(STORE_PLAN,{id, plan, updatedAt:new Date().toISOString()}); document.getElementById('status').textContent='Plan kaydedildi (override).'; document.getElementById('planModal').classList.remove('show'); render(); };
  refresh(); document.getElementById('planModal').classList.add('show'); }

/*********************** OneDrive Sync (Microsoft Graph) ***********************/
const GRAPH = { clientId: 'YOUR_CLIENT_ID', tenantId: 'common', scopes: ['Files.ReadWrite.AppFolder','User.Read'], redirectUri: location.origin + location.pathname };
let msalClient=null, account=null;
function initMsal(){ try{ msalClient = new msal.PublicClientApplication({ auth:{ clientId:GRAPH.clientId, authority:`https://login.microsoftonline.com/${GRAPH.tenantId}`, redirectUri:GRAPH.redirectUri }, cache:{ cacheLocation:'localStorage' } }); const accs=msalClient.getAllAccounts(); if(accs.length){ account=accs[0]; document.getElementById('signinBtn').style.display='none'; document.getElementById('signoutBtn').style.display='inline-block'; } }catch(e){ console.warn('MSAL init err',e); } }
async function getToken(){ if(!msalClient) return null; try{ const res = await msalClient.acquireTokenSilent({ account, scopes:GRAPH.scopes }); return res.accessToken; }catch(e){ const res = await msalClient.loginPopup({ scopes:GRAPH.scopes }); account=res.account; document.getElementById('signinBtn').style.display='none'; document.getElementById('signoutBtn').style.display='inline-block'; const tok=await msalClient.acquireTokenSilent({ account, scopes:GRAPH.scopes }); return tok.accessToken; } }
async function graphUpload(jsonStr){ const token=await getToken(); if(!token){ alert('Oturum açılamadı. Ayarları kontrol edin.'); return; } const url='https://graph.microsoft.com/v1.0/me/drive/special/approot:/tracker-backup.json:/content'; const res=await fetch(url,{ method:'PUT', headers:{ 'Authorization':'Bearer '+token, 'Content-Type':'application/json' }, body: jsonStr }); if(!res.ok){ const t=await res.text(); alert('OneDrive yükleme hatası: '+t); } else { document.getElementById('status').textContent='OneDrive senkron tamamlandı.'; } }
async function graphDownload(){ const token=await getToken(); if(!token){ alert('Oturum açılamadı.'); return; } const url='https://graph.microsoft.com/v1.0/me/drive/special/approot:/tracker-backup.json:/content'; const res=await fetch(url,{ headers:{ 'Authorization':'Bearer '+token } }); if(res.ok){ const txt=await res.text(); try{ const obj=JSON.parse(txt); if(obj.cfg) setCfg(obj.cfg); if(obj.logs){ for(const l of obj.logs){ await dbPut(STORE_LOGS,l);} } if(obj.plans||obj.plan){ const ar=obj.plans||obj.plan; for(const p of ar){ await dbPut(STORE_PLAN,p);} } document.getElementById('status').textContent='OneDrive yedeği içe aktarıldı.'; render(); }catch(e){ alert('Yedek parse hatası: '+e.message); } } else { alert('OneDrive’dan okunamadı (dosya yok olabilir).'); } }
async function syncNow(){ const logs=await dbAll(STORE_LOGS); const plans=await dbAll(STORE_PLAN); const payload={version:8, cfg:getCfg(), exportedAt:new Date().toISOString(), logs, plans}; await graphUpload(JSON.stringify(payload)); }

/*********************** Export / Import ***********************/
async function exportAll(){ const logs=await dbAll(STORE_LOGS); const plans=await dbAll(STORE_PLAN); const payload={version:8, cfg:getCfg(), exportedAt:new Date().toISOString(), logs, plans}; const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tracker-backup.json'; a.click(); a.remove(); }
function importAll(file){ if(!file) return; const reader=new FileReader(); reader.onload=async e=>{ try{ const obj=JSON.parse(e.target.result); if(obj.cfg) setCfg(obj.cfg); if(obj.logs){ for(const l of obj.logs){ await dbPut(STORE_LOGS,l);} } if(obj.plans||obj.plan){ const ar=obj.plans||obj.plan; for(const p of ar){ await dbPut(STORE_PLAN,p);} } document.getElementById('status').textContent='İçe aktarıldı.'; render(); } catch(err){ alert('İçe aktarma hatası: '+err.message);} }; reader.readAsText(file,'utf-8'); }

/*********************** Bindings & SW ***********************/
const weekSel=document.getElementById('week'); const daySel=document.getElementById('day');
weekSel.addEventListener('change', render); daySel.addEventListener('change', render);
document.getElementById('saveBtn').addEventListener('click', saveDraft);
document.getElementById('completeBtn').addEventListener('click', completeDay);
document.getElementById('recalcBtn').addEventListener('click', recalcNext);
document.getElementById('clearBtn').addEventListener('click', clearData);
document.getElementById('exportBtn').addEventListener('click', exportAll);
document.getElementById('importFile').addEventListener('change', e=>importAll(e.target.files[0]));
document.getElementById('settingsBtn').addEventListener('click', ()=>{ const c=getCfg(); ['repSuccess','repFail','repInc','repDec','repMin','repMax','setMin','setMax','timeUpPct','timeDownPct','timeMin'].forEach(id=>{ document.getElementById(id).value=c[id]; }); document.getElementById('exOverrides').value=JSON.stringify(c.exOverrides||{},null,2); document.getElementById('settingsModal').classList.add('show'); });
document.getElementById('closeSettings').addEventListener('click', ()=> document.getElementById('settingsModal').classList.remove('show'));
document.getElementById('saveSettings').addEventListener('click', ()=>{ const o={}; ['repSuccess','repFail','repInc','repDec','repMin','repMax','setMin','setMax','timeUpPct','timeDownPct','timeMin'].forEach(id=>{ o[id]=parseInt(document.getElementById(id).value); }); try{ o.exOverrides=JSON.parse(document.getElementById('exOverrides').value||'{}'); } catch{ alert('Geçersiz JSON'); return; } setCfg(o); document.getElementById('settingsModal').classList.remove('show'); document.getElementById('status').textContent='Ayarlar kaydedildi.'; });
document.getElementById('resetDefaults').addEventListener('click', ()=>{ setCfg(DEFAULTS); document.getElementById('status').textContent='Varsayılanlara dönüldü.'; });

document.getElementById('summaryBtn').addEventListener('click', async ()=>{ const week=parseInt(weekSel.value); const s=await weeklySummary(week); document.getElementById('summaryMeta').textContent=`Hafta ${week} — Tamamlama: %${s.completion} | Toplam tekrar: ${s.reps} | Toplam süre: ${s.secs}s`; drawBars(document.getElementById('summaryChart'), s.perDay); document.getElementById('reasonStats').textContent=s.reasonStr||''; document.getElementById('summaryModal').classList.add('show'); });
document.getElementById('closeSummary').addEventListener('click', ()=> document.getElementById('summaryModal').classList.remove('show'));

document.getElementById('prBtn').addEventListener('click', openPR);
document.getElementById('closePR').addEventListener('click', ()=> document.getElementById('prModal').classList.remove('show'));
document.getElementById('prExercise').addEventListener('change', renderPR);
document.getElementById('prType').addEventListener('change', renderPR);

document.getElementById('calendarBtn').addEventListener('click', openCalendar);
document.getElementById('closeCalendar').addEventListener('click', ()=> document.getElementById('calendarModal').classList.remove('show'));

// OneDrive
initMsal();
document.getElementById('signinBtn').addEventListener('click', async ()=>{ await getToken(); });
document.getElementById('signoutBtn').addEventListener('click', ()=>{ if(msalClient){ msalClient.logoutPopup(); account=null; document.getElementById('signinBtn').style.display='inline-block'; document.getElementById('signoutBtn').style.display='none'; } });
document.getElementById('syncBtn').addEventListener('click', async ()=>{ if(!account){ await getToken(); } if(confirm('OneDrive ile senkronize edilsin mi?')){ await syncNow(); }});

// Service Worker + update banner
if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').then(reg=>{ if(reg.waiting) showUpdateBanner(reg.waiting); reg.addEventListener('updatefound', ()=>{ const sw=reg.installing; sw&&sw.addEventListener('statechange', ()=>{ if(sw.state==='installed' && navigator.serviceWorker.controller){ showUpdateBanner(sw); } }); }); navigator.serviceWorker.addEventListener('controllerchange', ()=> window.location.reload()); }).catch(err=> console.warn('SW register fail', err)); }
function showUpdateBanner(sw){ const b=document.getElementById('updateBanner'); b.classList.add('show'); document.getElementById('reloadBtn').onclick=()=> sw.postMessage({type:'SKIP_WAITING'}); }

render();
</script>
</body>
</html>